# Oracle PL/SQL Package Body 代码结构解析器技术设计文档

## 1. 节点对象定义

一个节点对象包含如下元素：
1. 类型：包体(Package Body)、函数(Function)或过程(Procedure)
2. 名称
3. 声明行行号
4. BEGIN 行行号
5. EXCEPTION 行行号 (可为NULL，默认为NULL)
6. END 行行号
7. 层级
8. 子节点数组：存储当前节点的所有子函数/过程
9. 函数/过程规格说明：IS/AS行行号（包体专用）

## 2. 全局变量定义

1. 层级的全局变量
2. BEGIN_END_COUNTER
3. 节点栈：用于管理父子节点关系
4. 当前活动节点指针：指向正在处理的节点
5. 根节点集合：存储所有顶层节点
6. 包体节点指针：指向当前包体节点
7. 包体初始化段标识：标识是否已进入包体初始化段

## 3. 解析流程

### 3.1 初始化处理

在开始解析前，初始化所有全局变量：节点栈清空、当前活动节点设为NULL、层级全局变量设为0、BEGIN_END_COUNTER设为0、根节点集合清空、包体节点指针设为NULL、包体初始化段标识设为FALSE。

### 3.2 预处理步骤

逐行读取代码文件时，先进行预处理：
- 去除行首尾空白字符
- 跳过空行和注释行（以--开头或/**/包围的行）
- 使用正则表达式进行精确的关键字匹配，避免误识别字符串中的关键字

### 3.3 CREATE OR REPLACE PACKAGE BODY 处理

如果为CREATE OR REPLACE PACKAGE BODY 行，读取包名作为顶层节点。创建节点对象并赋值类型=包体、名称、声明行行号、层级=1。层级的全局变量设为1。将该节点设为当前活动节点和包体节点指针，并添加到根节点集合中。

### 3.4 包体内容处理

#### 3.4.1 包体函数/过程声明处理

如果读取到FUNCTION/PROCEDURE关键字（非嵌套函数/过程），执行如下动作：

3.4.1.1 创建新的节点对象，并赋值类型、名称、声明行行号。将当前活动节点（包体节点）的子节点数组中添加新节点，层级的全局变量 = 2。

3.4.1.2 继续读取直到遇到IS/AS关键字，记录IS/AS行行号。

3.4.1.3 将新节点设为当前活动节点，将包体节点压入节点栈。

3.4.1.4 如果接下来读取到BEGIN，则执行BEGIN关键字处理流程。

3.4.1.5 如果接下来读取到嵌套的FUNCTION/PROCEDURE，则执行子函数/过程处理流程。

#### 3.4.2 包体初始化段处理

如果在包体层级（层级=1）读取到BEGIN关键字，说明进入包体初始化段：

3.4.2.1 将包体初始化段标识设为TRUE，记录包体节点的BEGIN行行号，BEGIN_END_COUNTER=1。

3.4.2.2 继续逐行读取，按照标准的BEGIN/END处理逻辑进行。

3.4.2.3 在此段中如果遇到EXCEPTION关键字，记录包体节点的EXCEPTION行行号。

3.4.2.4 读取到最终的END关键字时，记录包体节点的END行行号，解析完成。

#### 3.4.3 嵌套函数/过程处理

在函数/过程内部如果读取到的是FUNCTION/PROCEDURE关键字，则说明是嵌套函数/过程：

3.4.3.1 创建新的节点对象，并赋值类型、名称、声明行行号。将当前活动节点压入节点栈，将当前活动节点的子节点数组中添加新节点，然后将"当前活动节点"设置为新建的节点对象。

3.4.3.2 层级的全局变量 = 层级的全局变量 + 1。并将计算后的层级的全局变量赋值为当前节点对象的层级。重置BEGIN_END_COUNTER=0。

3.4.3.3 继续读取直到遇到IS/AS关键字，记录IS/AS行行号。

3.4.3.4 继续读取代码，如果读取到BEGIN，则重复BEGIN关键字处理的动作。

3.4.3.5 如果又读到FUNCTION/PROCEDURE关键字，则重复嵌套函数/过程处理的动作。

#### 3.4.4 BEGIN关键字处理

如果读取到BEGIN关键字（非包体初始化段），说明函数/过程声明部分结束：

3.4.4.1 赋值当前活动节点的BEGIN行行号，BEGIN_END_COUNTER=1。

3.4.4.2 继续逐行读取，如果接下来再读取到BEGIN关键字，BEGIN_END_COUNTER = BEGIN_END_COUNTER + 1。判断 BEGIN_END_COUNTER 是否等于1，如果不等于1则不解析其他关键字。

3.4.4.3 读取到EXCEPTION关键字时，判断BEGIN_END_COUNTER 是否等于1，如果不等于1则不解析。如果等于1则记录当前活动节点的EXCEPTION行行号。

3.4.4.4 读取到END关键字，BEGIN_END_COUNTER = BEGIN_END_COUNTER - 1并判断 BEGIN_END_COUNTER 是否等于0，如果不等于0则不解析。如果等于0则记录END行行号。完成后将层级的全局变量设为层级的全局变量-1。从节点栈中弹出父节点，将当前活动节点指针设置为父节点。

### 3.5 错误处理和边界条件

3.5.1 语法容错处理：遇到不规范的代码结构时，记录错误但继续解析后续内容。

3.5.2 嵌套深度限制：设置合理的嵌套深度上限，防止无限递归。

3.5.3 文件结束处理：文件读取完毕后，检查是否还有未完成的节点，进行适当的收尾处理。

3.5.4 包体完整性检查：确保包体有正确的END语句且包名匹配。

## 4. 关键字匹配规则

- CREATE OR REPLACE PACKAGE BODY：`CREATE\s+OR\s+REPLACE\s+PACKAGE\s+BODY\s+(\w+)`
- 包体内函数/过程：`^\s*(FUNCTION|PROCEDURE)\s+(\w+)`
- IS/AS语句：`^\s*(IS|AS)\s*$`
- BEGIN：`^\s*BEGIN\s*$`
- EXCEPTION：`^\s*EXCEPTION\s*$`
- END：`^\s*END(\s+\w+)?\s*;\s*$`
- 注释：`^\s*(--.*|\/\*.*\*\/)\s*$`
- 空行：`^\s*$`

## 5. 包体特殊处理规则

### 5.1 层级管理规则

- 包体本身：层级 = 1
- 包体内的函数/过程：层级 = 2
- 嵌套函数/过程：层级 = 父级层级 + 1

### 5.2 节点关系管理

- 包体节点作为根节点
- 包体内的函数/过程作为包体节点的直接子节点
- 嵌套函数/过程按照标准的父子关系管理

### 5.3 包体初始化段识别

- 在包体层级（层级=1）遇到第一个BEGIN即为包体初始化段开始
- 包体初始化段可包含EXCEPTION处理
- 包体必须以END package_name; 或 END; 结束

## 6. 输出结果

解析完成后，返回根节点集合，其中包体节点包含完整的层次结构：
- 包体节点包含其内部所有函数/过程的位置信息
- 每个函数/过程节点包含其IS/AS位置、BEGIN位置、可选的EXCEPTION位置和END位置
- 嵌套函数/过程通过子节点数组形成树状结构
- 包体初始化段的位置信息记录在包体节点中