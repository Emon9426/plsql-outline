# Oracle PL/SQL Package Header 代码结构解析器技术设计文档

## 1. 节点对象定义

一个节点对象包含如下元素：
1. 类型：包头(Package Header)、函数声明(Function Declaration)或过程声明(Procedure Declaration)
2. 名称
3. 声明行行号
4. END 行行号（仅包头节点使用）
5. 层级（固定为1或2）
6. 子节点数组：存储当前包头的所有函数/过程声明

## 2. 全局变量定义

1. 当前活动节点指针：指向正在处理的包头节点
2. 根节点集合：存储所有顶层节点
3. 包头节点指针：指向当前包头节点

## 3. 解析流程

### 3.1 初始化处理

在开始解析前，初始化所有全局变量：当前活动节点设为NULL、根节点集合清空、包头节点指针设为NULL。

### 3.2 预处理步骤

逐行读取代码文件时，先进行预处理：
- 去除行首尾空白字符
- 跳过空行和注释行（以--开头或/**/包围的行）
- 使用正则表达式进行精确的关键字匹配，避免误识别字符串中的关键字

### 3.3 CREATE OR REPLACE PACKAGE 处理

如果为CREATE OR REPLACE PACKAGE 行，读取包名作为顶层节点。创建节点对象并赋值类型=包头、名称、声明行行号、层级=1。将该节点设为当前活动节点和包头节点指针，并添加到根节点集合中。

### 3.4 包头内容处理

#### 3.4.1 函数/过程声明处理

如果读取到FUNCTION/PROCEDURE关键字，执行如下动作：

3.4.1.1 创建新的节点对象，并赋值类型=函数声明/过程声明、名称、声明行行号、层级=2。

3.4.1.2 将新节点添加到当前活动节点（包头节点）的子节点数组中。

3.4.1.3 继续读取代码，直到遇到分号(;)，表示该函数/过程声明结束。

3.4.1.4 继续处理下一行代码。

#### 3.4.2 END关键字处理

如果读取到END关键字，说明包头声明结束：

3.4.2.1 验证END后是否跟着包名或直接以分号结束。

3.4.2.2 记录包头节点的END行行号。

3.4.2.3 包头解析完成。

#### 3.4.3 其他声明处理

包头中可能包含其他声明（类型声明、变量声明、常量声明等）：

3.4.3.1 识别但不解析这些声明的内部结构。

3.4.3.2 跳过这些声明，继续寻找FUNCTION/PROCEDURE关键字。

### 3.5 错误处理和边界条件

3.5.1 语法容错处理：遇到不规范的代码结构时，记录错误但继续解析后续内容。

3.5.2 文件结束处理：文件读取完毕后，检查包头是否有正确的END语句。

3.5.3 包头完整性检查：确保包头有正确的END语句且包名匹配。

## 4. 关键字匹配规则

- CREATE OR REPLACE PACKAGE：`CREATE\s+OR\s+REPLACE\s+PACKAGE\s+(\w+)`
- 函数/过程声明：`^\s*(FUNCTION|PROCEDURE)\s+(\w+)`
- END：`^\s*END(\s+\w+)?\s*;\s*$`
- 注释：`^\s*(--.*|\/\*.*\*\/)\s*$`
- 空行：`^\s*$`
- 分号结束：`;\s*$`

## 5. 包头特殊处理规则

### 5.1 层级管理规则

- 包头本身：层级 = 1
- 包头内的函数/过程声明：层级 = 2

### 5.2 节点关系管理

- 包头节点作为根节点
- 包头内的函数/过程声明作为包头节点的直接子节点
- 无嵌套结构，所有声明都是平级的

### 5.3 声明识别规则

- 函数/过程声明以FUNCTION/PROCEDURE关键字开始，以分号结束
- 不关心声明的具体参数和返回值类型
- 只提取函数/过程名称和位置信息

### 5.4 包头结束条件

- 遇到END关键字且后面跟包名或直接分号结束
- END关键字必须在包头层级（层级=1）

## 6. 解析状态管理

### 6.1 解析状态定义

- PACKAGE_START：开始解析包头
- READING_DECLARATIONS：正在读取声明部分
- PACKAGE_END：包头解析结束

### 6.2 状态转换规则

- 遇到CREATE OR REPLACE PACKAGE：状态转为PACKAGE_START
- 开始读取包头内容：状态转为READING_DECLARATIONS
- 遇到END关键字：状态转为PACKAGE_END

## 7. 输出结果

解析完成后，返回根节点集合，其中包头节点包含完整的声明结构：
- 包头节点包含其内部所有函数/过程声明的位置信息
- 每个函数/过程声明节点包含其声明位置
- 包头的END位置信息记录在包头节点中
- 所有声明节点通过子节点数组组织，形成扁平的树状结构

## 8. 示例解析流程

```sql
CREATE OR REPLACE PACKAGE pkg_example AS  -- 创建包头节点，层级=1

  FUNCTION func1(p1 NUMBER) RETURN VARCHAR2;  -- 创建函数声明节点，层级=2

  PROCEDURE proc1(p1 IN NUMBER, p2 OUT VARCHAR2);  -- 创建过程声明节点，层级=2

END pkg_example;  -- 记录包头节点的END行号，解析完成
```